name: qwiet.ai

on:
  pull_request:
  workflow_dispatch:
  push:

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  NextGen-Static-Analysis:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    # - name: Qwiet-AllInOne-Scan
    #   uses: elangosenthilnathan/Qwiet-preZero@v0.0.1
    #   with:
    #     shiftleft-access-token: ${{ secrets.SHIFTLEFT_ACCESS_TOKEN }}
    #     verbose: false
    #     strict: true
    #     wait: false
    #     importGitHub: false

    - name: Check OS and Install Relevant Qwiet Binary
      shell: bash
      run: |
        if [[ "${{ runner.os }}" == "Linux" ]]; then
          curl https://cdn.shiftleft.io/download/sl > $HOME/sl && chmod a+rx $HOME/sl
          sudo mv $HOME/sl /usr/local/bin/
        elif [[ "${{ runner.os }}" == "Windows" ]]; then
          Invoke-WebRequest -Uri 'https://cdn.shiftleft.io/download/sl-latest-windows-x64.zip' -UseBasicParsing -OutFile sl-latest-windows-x64.zip
          Expand-Archive -Path sl-latest-windows-x64.zip -DestinationPath .
          $env:Path = $env:Path + ";.\sl" +  ";." 
        else
          echo "Unsupported OS: ${{ runner.os }}"
          exit 1
        fi 

    - name: Publish PR Comment
      #if: github.event_name == 'pull_request'
      run: |
          sl check-analysis --v2 --app "${GITHUB_REPOSITORY_OWNER}-${GITHUB_REPOSITORY#*/}" --no-build-rules --report-file checkanalysis-report.md
          echo "*********************"
          cat checkanalysis-report.md
          echo "*********************"
          python3 ghComment.py --github_org "${GITHUB_REPOSITORY_OWNER}" --github_repo "${GITHUB_REPOSITORY#*/}" --github_pat ${GH_API_TOKEN} --github_pr_number 16 --filename  checkanalysis-report.md
      
      env:
        SHIFTLEFT_ACCESS_TOKEN: ${{ secrets.SHIFTLEFT_ACCESS_TOKEN }}
        GH_API_TOKEN: ${{ secrets.GITHUB_TOKEN }}          
          

